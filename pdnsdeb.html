<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" type="text/css" href="src/style.css">
<title>digrea.pro</title>
</head>
<body>
<div id="outblock" align="center">
<div id="innblock">
<div id="subblock">
<div class="maincont">

<!-- START CONTENT HERE -->

<p class="conthead">Кэширующий DNS-сервер pdnsd</p>
<hr class="contline">
<div class="contlead">
<p><span class="contdate">Аннотация:&nbsp;&nbsp;</span>Установка и настройка кэширующего DNS-сервера <b>pdnsd</b> на Debian 8 Jessie.<br>
<span class="contdate">Дата:&nbsp;&nbsp;</span>Февраль 2016.&nbsp;&nbsp;<span class="contdate">Обновление:&nbsp;&nbsp;</span>Март 2022.<br>
<span class="contdate">Статус статьи:&nbsp;&nbsp;</span>pg_stat.</p>
</div><br>
<div class="conttext">
<p><span class="textmark">PDNSD (Proxy DNS Daemon)</span> &ndash; это достаточно быстрый кэширующий DNS-сервер, который способен одновременно отправлять запросы на два разных DNS-сервера выше уровнем.</p>
<p class="textwarn">Debian 8 Jessie &ndash; последняя операционная система семейства, в которой пакет <b>pdnsd</b> можно поставить из стандартных репозиториев.</p>
<p>Установим пакет pdnsd:</p>
<div class="messtext">
<p>$ <span class="textcopy">sudo apt-get install pdnsd</span></p>
</div>
<p>В процессе установки появится окно с запросом о способе установки pdnsd. Если же нет, то его можно вызвать самостоятельно:</p>
<div class="messtext">
<p>$ <span class="textcopy">sudo dpkg-reconfigure pdnsd</span></p>
</div>
<p>В этой статье рассматривается использование сервера без привязки к DNS-серверам провайдеров и т.п., поэтому в данном случае выбирается режим использования&nbsp;&nbsp;<span class="textmark">корневых серверов (root-servers)</span>.</p>
<p><span class="textmark"><b>Для справки:</b></span> <b>Корневые серверы DNS</b> &ndash; DNS-серверы, обеспечивающие работу корневой зоны DNS в сети Интернет. Они отвечают на запросы других DNS-серверов в ходе трансляции доменных имён в ip-адреса и позволяют получить список DNS-серверов для любого домена верхнего уровня. Существует тринадцать корневых серверов DNS, их доменные имена имеют вид <span class="textmark"><i>letter</i>.root-servers.org</span>, где <span class="textmark"><i>letter</i></span> &ndash; буква от A до M.</p>
<p>Для настройки запуска pdnsd необходимо привести файл&nbsp;&nbsp;<span class="textmark textcopy">/etc/default/pdnsd</span>&nbsp;&nbsp;к следующему виду:</p>
<div class="messfile textcopy">
<p>START_DAEMON=yes<br>
AUTO_MODE=recurse<br>
START_OPTIONS=</p>
</div>
<p>В данном режиме pdnsd будет брать настройки из файла <span class="textmark">/usr/share/pdnsd/pdnsd-recurse.conf</span>, а не из <span class="textmark">/etc/pdnsd.conf</span>. Отредактируем файл:</p>
<div class="messtext">
<p>$ <span class="textcopy">sudo nano /usr/share/pdnsd/pdnsd-recurse.conf</span></p>
</div>
<p>В секции <span class="textmark">global</span> параметр <span class="textmark">perm_cache</span> определяет сколько дискового пространства в килобайтах будет отводиться под кэш. Параметр <span class="textmark">server_ip</span> определяет интерфейс, на котором pdnsd будет принимать запросы. В данном примере меняем на <span class="textmark">eth0</span>.</p>
<p class="textwarn">Если был установлен какой-либо другой DNS-сервер (например, dnsmasq), то его необходимо удалить, т.к. порт по-умолчанию (53) будет занят.</p>
<p>Файл&nbsp;&nbsp;<span class="textmark">/etc/resolv.conf</span>&nbsp;&nbsp;формируется пакетом <span class="textmark">resolvconf</span>, поэтому в его настройках необходимо указать созданный DNS-сервер:</p>
<div class="messtext">
<p>$ <span class="textcopy">sudo nano /etc/resolvconf/resolv.conf.d/base</span></p>
</div>
<p>Вписываем nameserver и ip-адрес интерфейса&nbsp;&nbsp;<span class="textmark">eth0:</span></p>
<div class="messfile textcopy">
<p>nameserver 192.168.0.20</p>
</div>
<p class="textwarn">В файле конфигурации сетевых интерфейсов <span class="textcopy"><b>/etc/network/interfaces</b></span> не должно быть строк с параметрами <b>dns-nameservers!</b> Также желательно проверить файл <span class="textcopy"><b>/etc/hosts</b></span> на наличие записи основного сетевого интерфейса и соответствия ему актуального <b>hostname</b>.</p>
<p>После перезагрузки необходимо проверить, что в файле&nbsp;&nbsp;<span class="textmark">/etc/resolv.conf</span>&nbsp;&nbsp;указан нужный ip-адрес.<br>В данном примере это &ndash; <span class="textmark">192.168.0.20</span>:</p>
<div class="messtext">
<p>$ <span class="textcopy">cat /etc/resolv.conf</span></p>
</div><br>
<div class="messview">
<p># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)<br>
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN<br>
nameserver 192.168.0.20</p>
</div>
<p>Теперь с помощью команды&nbsp;&nbsp;<span class="textmark">dig</span> убедимся, что запросы обрабатываются:</p>
<div class="messtext">
<p>$ <span class="textcopy">dig google.ru</span></p>
</div>
<p>Вывод команды:</p>
<div class="messview">
<p>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; google.ru<br>
;; global options: +cmd<br>
;; Got answer:<br>
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 14808<br>
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1<br>
<br>
;; OPT PSEUDOSECTION:<br>
; EDNS: version: 0, flags:; udp: 65494<br>
;; QUESTION SECTION:<br>
;google.ru.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;&nbsp;&nbsp;&nbsp;A<br>
<br>
;; ANSWER SECTION:<br>
google.ru.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;300&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;142.251.1.94<br>
<br>
;; Query time: 106 msec<br>
;; SERVER: 127.0.0.53#53(127.0.0.53)<br>
;; WHEN: Mon Mar 21 17:10:53 MSK 2022<br>
;; MSG SIZE  rcvd: 54</p>
</div>
<p class="textwarn">Если в Debian нет утилиты <b>dig</b>, то необходимо доставить пакет <b>dnsutils</b>.</p>
<p>Некоторые полезные команды:</p>
<p><span class="textmark textcopy">pdnsd-ctl status</span> &ndash; текущее состояние и заполненность кэша pdnsd.<br>
<span class="textmark textcopy">pdnsd-ctl dump</span> &ndash; содержимое кэша.<br>
<span class="textmark textcopy">pdnsd-ctl empty-cache</span> &ndash; сброс (очистка) кэша.</p>
<a name="localdns"></a><p style="font-size: 1px">&nbsp;</p>
<p class="contsubs">Локальные запросы</p>
<p class="textwarn">Для обработки локальных запросов можно использовать секцию <b>rr</b> основного конфигурационного файла <span class="textcopy"><b>/usr/share/pdnsd/pdnsd-recurse.conf</b></span> (не <b>/etc/pdnsd.conf</b> &ndash; т.к. используется настройка через ROOT-серверы).</p>
<p>Конструкция следующая:</p>
<div class="messfile textcopy">
<p>rr {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=hostname.lan;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a=192.168.0.51;<br>
}
</p>
</div>
<p>Здесь всё просто:&nbsp;&nbsp;<span class="textmark">a</span> &ndash; это ip-адрес хоста, а&nbsp;&nbsp;<span class="textmark">name</span> &ndash; его hostname.</p>
<p>После внесения изменений нужно перезапустить сервис:</p>
<div class="messtext">
<p>$ <span class="textcopy">sudo service pdnsd restart</span></p>
</div>
</div>

<!-- END OF CONTENT -->

</div></div></div></div>
</body>
</html>
